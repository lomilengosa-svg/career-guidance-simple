<!DOCTYPE html>
<html>
<head>
    <title>Career Guidance System</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="hero-section">
        <div class="container">
            <h1>Welcome to Career Guidance System</h1>
            <p>Your pathway to academic and professional success</p>
        </div>
    </div>

    <div class="container">
        <div class="grid grid-3">
            <div class="feature-card">
                <h3>For Students</h3>
                <p>• Apply to institutions</p>
                <p>• Track applications</p>
                <p>• Find matching jobs</p>
                <p>• Access career guidance</p>
            </div>
            <div class="feature-card">
                <h3>For Institutions</h3>
                <p>• Manage courses</p>
                <p>• Review applications</p>
                <p>• Track admissions</p>
                <p>• Connect with students</p>
            </div>
            <div class="feature-card">
                <h3>For Companies</h3>
                <p>• Post job opportunities</p>
                <p>• Find qualified candidates</p>
                <p>• Track applications</p>
                <p>• Connect with talent</p>
            </div>
        </div>

        <div id="apiStatus" class="status">Checking API connection...</div>

        <div class="auth-section" id="authForm">
            <h2>Login</h2>
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Login</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleForm('register')">Register</button>
                </div>
            </form>
        </div>

        <div class="auth-section" id="registerForm" style="display: none;">
            <h2>Register</h2>
            <form onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password:</label>
                    <input type="password" id="regPassword" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="role">Role:</label>
                    <select id="role" class="form-control" required>
                        <option value="student">Student</option>
                        <option value="institution">Institution</option>
                        <option value="company">Company</option>
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Register</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleForm('login')">Back to Login</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { auth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js';
        import config from './config.js';
        import { redirectToDashboard, checkAuthState } from './js/router.js';

        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCrey2RFEfbEeBgttub67k0FqFRjcizJXI",
            authDomain: "career-guidance-simple.firebaseapp.com",
            projectId: "career-guidance-simple",
            storageBucket: "career-guidance-simple.firebasestorage.app",
            messagingSenderId: "837363883387",
            appId: "1:837363883387:web:4bff47a967605fd9cbf1de"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Check API connection
        async function checkApiStatus() {
            const statusElement = document.getElementById('apiStatus');
            try {
                const response = await fetch(`${config.apiUrl}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    statusElement.textContent = `Backend API is connected! Status: ${data.status}`;
                    statusElement.className = 'status success';
                } else {
                    throw new Error(data.message || 'API request failed');
                }
            } catch (error) {
                statusElement.textContent = `Error connecting to backend API (${config.apiUrl}). Error: ${error.message}`;
                statusElement.className = 'status error';
                console.error('API Error:', error);
            }
        }

        // Make functions globally available
        window.handleLogin = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const result = await signInWithEmailAndPassword(auth, email, password);
                const idToken = await result.user.getIdToken();
                
                const response = await fetch(`${config.apiUrl}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ idToken })
                });
                
                const data = await response.json();
                if (data.success) {
                    localStorage.setItem('token', idToken);
                    localStorage.setItem('role', data.role);
                    redirectToDashboard(data.role);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        };

        window.handleRegister = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const role = document.getElementById('role').value;
            
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const idToken = await userCredential.user.getIdToken();
                
                const response = await fetch(`${config.apiUrl}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password, role })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Registration successful! Please check your email for verification.');
                    toggleForm('login');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed: ' + error.message);
            }
        };

        window.toggleForm = function(form) {
            if (form === 'register') {
                document.getElementById('authForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            } else {
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkApiStatus();
            checkAuthState();
        });
    </script>
</body>
</html>
